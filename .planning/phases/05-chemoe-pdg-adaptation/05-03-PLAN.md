---
phase: 05-chemoe-pdg-adaptation
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - data/topk_r2_results.csv
  - trained_models/chemoe_pdg_*
autonomous: true

must_haves:
  truths:
    - "CheMoE trained on all 9 cell lines (fold 0)"
    - "Each cell line has R2 top-20/40/80 metrics in results CSV"
    - "Model checkpoints saved for each cell line"
    - "Training completes without OOM or crashes"
  artifacts:
    - path: "data/topk_r2_results.csv"
      provides: "CheMoE results appended"
      contains: "CheMoE"
  key_links:
    - from: "data/topk_r2_results.csv"
      to: "train_chemoe_pdg.py"
      via: "save_results_to_csv function"
      pattern: "model.*CheMoE"
---

<objective>
Train CheMoE_PDG on all 9 cell lines (fold 0) and collect results for baseline comparison.

Purpose: Complete the CheMoE baseline evaluation to add to the model comparison table.

Output: 9 trained models and results appended to `data/topk_r2_results.csv`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/raid/home/joshua/projects/PDGrapher_Baseline_Models/.planning/phases/05-chemoe-pdg-adaptation/05-CONTEXT.md
@/raid/home/joshua/projects/PDGrapher_Baseline_Models/.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Train CheMoE on all 9 cell lines</name>
  <files>data/topk_r2_results.csv, trained_models/</files>
  <action>
Run training for all 9 cell lines in parallel (distribute across GPUs):

**Cell lines to train:**
- A375, A549, BT20, HELA, HT29, MCF7, MDAMB231, PC3, VCAP

**Training configuration:**
- fold: 0 (to match other baselines in current CSV)
- epochs: 100
- batch_size: 64
- lr: 1e-4
- weight_decay: 1e-3
- num_experts: 4
- top_k: 2
- aux_loss_weight: 0.01

**Launch commands (run in parallel using nohup or screen):**

GPU 0-3 (first batch):
```bash
cd /raid/home/joshua/projects/PDGrapher_Baseline_Models
nohup python train_chemoe_pdg.py --cell_line A375 --fold 0 --gpu 0 > logs/chemoe_A375.log 2>&1 &
nohup python train_chemoe_pdg.py --cell_line A549 --fold 0 --gpu 1 > logs/chemoe_A549.log 2>&1 &
nohup python train_chemoe_pdg.py --cell_line BT20 --fold 0 --gpu 2 > logs/chemoe_BT20.log 2>&1 &
nohup python train_chemoe_pdg.py --cell_line HELA --fold 0 --gpu 3 > logs/chemoe_HELA.log 2>&1 &
```

GPU 4-7 (second batch):
```bash
nohup python train_chemoe_pdg.py --cell_line HT29 --fold 0 --gpu 4 > logs/chemoe_HT29.log 2>&1 &
nohup python train_chemoe_pdg.py --cell_line MCF7 --fold 0 --gpu 5 > logs/chemoe_MCF7.log 2>&1 &
nohup python train_chemoe_pdg.py --cell_line MDAMB231 --fold 0 --gpu 6 > logs/chemoe_MDAMB231.log 2>&1 &
nohup python train_chemoe_pdg.py --cell_line PC3 --fold 0 --gpu 7 > logs/chemoe_PC3.log 2>&1 &
```

Remaining (when GPU available):
```bash
nohup python train_chemoe_pdg.py --cell_line VCAP --fold 0 --gpu 0 > logs/chemoe_VCAP.log 2>&1 &
```

**Create logs directory first:**
```bash
mkdir -p /raid/home/joshua/projects/PDGrapher_Baseline_Models/logs
```

**Monitor progress:**
```bash
tail -f logs/chemoe_*.log
```

**Expected runtime:** ~30-60 min per cell line depending on GPU and data size.
  </action>
  <verify>
```bash
cd /raid/home/joshua/projects/PDGrapher_Baseline_Models
# Check all 9 cell lines have results
grep "CheMoE" data/topk_r2_results.csv | wc -l
```
Returns 9 (one row per cell line).
  </verify>
  <done>
- All 9 cell lines trained (A375, A549, BT20, HELA, HT29, MCF7, MDAMB231, PC3, VCAP)
- Each has entry in data/topk_r2_results.csv
- Model checkpoints saved in trained_models/chemoe_pdg_{cell}_fold0/
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify results and update STATE.md</name>
  <files>None (read-only verification)</files>
  <action>
After training completes, verify results quality and summarize:

1. **Check CSV for all entries:**
```bash
grep "CheMoE" data/topk_r2_results.csv
```

2. **Compute mean R2 top-20 across cell lines:**
```python
import pandas as pd
df = pd.read_csv('data/topk_r2_results.csv')
chemoe = df[df['model'] == 'CheMoE']
print(f"CheMoE Mean R2 Top-20: {chemoe['r2_top20'].mean():.4f}")
print(f"CheMoE Mean R2 Top-40: {chemoe['r2_top40'].mean():.4f}")
print(f"CheMoE Mean R2 Top-80: {chemoe['r2_top80'].mean():.4f}")
print(f"Per cell line:")
print(chemoe[['cell_line', 'r2_top20', 'r2_top40', 'r2_top80']])
```

3. **Compare to other models:**
```python
# Get mean R2 top-20 per model
model_means = df.groupby('model')['r2_top20'].mean().sort_values(ascending=False)
print(model_means)
```

4. **Check for any anomalies:**
- R2 values should be between 0 and 1
- No NaN or negative values
- Results comparable to other MoE models (TranSiGen_MoE_Sparse: 0.7454)

5. **Document final results in summary.**
  </action>
  <verify>
All 9 CheMoE entries exist in CSV with valid R2 values (0 < R2 < 1).
  </verify>
  <done>
- 9/9 cell lines have valid results
- Mean R2 top-20 computed and compared to other models
- No anomalies detected
- Results ready for comparison table
  </done>
</task>

</tasks>

<verification>
1. CSV check: `grep "CheMoE" data/topk_r2_results.csv | wc -l` returns 9
2. Model files: `ls trained_models/chemoe_pdg_*` shows 9 directories
3. WandB: Project CheMoE_PDG_AE_DE has 9 runs
4. Quality: Mean R2 top-20 is positive and reasonable (0.5-0.9 range expected)
</verification>

<success_criteria>
- CheMoE trained on all 9 cell lines (fold 0)
- Results appended to data/topk_r2_results.csv
- Mean R2 top-20 computed for model comparison
- No training failures or anomalous results
- Phase 5 deliverables complete per ROADMAP.md
</success_criteria>

<output>
After completion, create `.planning/phases/05-chemoe-pdg-adaptation/05-03-SUMMARY.md`
</output>
